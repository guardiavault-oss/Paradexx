// Comprehensive Backend Services Test Script
import axios from 'axios';
import dotenv from 'dotenv';
import * as fs from 'fs';
import * as path from 'path';

dotenv.config({ path: path.join(__dirname, '../.env') });

const API_BASE = process.env.APP_URL || 'http://localhost:3001/api';
let accessToken = '';

interface TestResult {
  service: string;
  endpoint: string;
  status: 'pass' | 'fail' | 'skip';
  message: string;
  duration?: number;
}

const results: TestResult[] = [];

// Helper to make authenticated requests
async function apiRequest(endpoint: string, options: any = {}) {
  const url = `${API_BASE}${endpoint}`;
  const headers = {
    'Content-Type': 'application/json',
    ...(accessToken && { Authorization: `Bearer ${accessToken}` }),
    ...options.headers,
  };

  try {
    const start = Date.now();
    const response = await axios({
      url,
      method: options.method || 'GET',
      headers,
      data: options.body,
      timeout: 30000,
    });
    const duration = Date.now() - start;
    return { data: response.data, duration };
  } catch (error: any) {
    const duration = Date.now() - (Date.now());
    return {
      error: error.response?.data?.error || error.message,
      status: error.response?.status,
      duration,
    };
  }
}

// Test authentication
async function testAuth() {
  console.log('\nðŸ” Testing Authentication...');
  
  // Register test user
  const registerResult = await apiRequest('/auth/register', {
    method: 'POST',
    body: {
      email: `test-${Date.now()}@test.com`,
      password: 'TestPassword123!',
      name: 'Test User',
    },
  });

  if (registerResult.error && !registerResult.error.includes('already exists')) {
    results.push({
      service: 'Auth',
      endpoint: 'POST /auth/register',
      status: 'fail',
      message: registerResult.error,
      duration: registerResult.duration,
    });
  } else {
    results.push({
      service: 'Auth',
      endpoint: 'POST /auth/register',
      status: 'pass',
      message: 'User registered or already exists',
      duration: registerResult.duration,
    });
  }

  // Login
  const loginResult = await apiRequest('/auth/login', {
    method: 'POST',
    body: {
      email: 'test@test.com',
      password: 'TestPassword123!',
    },
  });

  if (loginResult.data?.access_token) {
    accessToken = loginResult.data.access_token;
    results.push({
      service: 'Auth',
      endpoint: 'POST /auth/login',
      status: 'pass',
      message: 'Login successful',
      duration: loginResult.duration,
    });
  } else {
    results.push({
      service: 'Auth',
      endpoint: 'POST /auth/login',
      status: 'fail',
      message: loginResult.error || 'No token received',
      duration: loginResult.duration,
    });
    console.log('âš ï¸  Authentication failed. Some tests will be skipped.');
  }
}

// Test MEV Protection
async function testMEVProtection() {
  console.log('\nðŸ›¡ï¸  Testing MEV Protection...');

  const analysis = await apiRequest('/security/mev/analyze', {
    method: 'POST',
    body: {
      from: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb',
      to: '0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D',
      data: '0x7ff36ab500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 optional
      value: '100000000000000000',
    },
  });

  if (analysis.error) {
    results.push({
      service: 'MEV Protection',
      endpoint: 'POST /security/mev/analyze',
      status: 'fail',
      message: analysis.error,
      duration: analysis.duration,
    });
  } else {
    results.push({
      service: 'MEV Protection',
      endpoint: 'POST /security/mev/analyze',
      status: 'pass',
      message: `Risk level: ${analysis.data?.riskLevel || 'unknown'}`,
      duration: analysis.duration,
    });
  }
}

// Test Honeypot Detection
async function testHoneypotDetection() {
  console.log('\nðŸ¯ Testing Honeypot Detection...');

  if (!accessToken) {
    results.push({
      service: 'Honeypot Detection',
      endpoint: 'POST /security/honeypot/check',
      status: 'skip',
      message: 'Authentication required',
    });
    return;
  }

  const check = await apiRequest('/security/honeypot/check', {
    method: 'POST',
    body: {
      tokenAddress: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', // USDC
      chainId: 1,
    },
  });

  if (check.error) {
    results.push({
      service: 'Honeypot Detection',
      endpoint: 'POST /security/honeypot/check',
      status: 'fail',
      message: check.error,
      duration: check.duration,
    });
  } else {
    results.push({
      service: 'Honeypot Detection',
      endpoint: 'POST /security/honeypot/check',
      status: 'pass',
      message: `Risk: ${check.data?.riskLevel || 'unknown'}, Score: ${check.data?.riskScore || 'N/A'}`,
      duration: check.duration,
    });
  }
}

// Test Bridge Service
async function testBridgeService() {
  console.log('\nðŸŒ‰ Testing Bridge Service...');

  if (!accessToken) {
    results.push({
      service: 'Bridge',
      endpoint: 'GET /bridge/chains',
      status: 'skip',
      message: 'Authentication required',
    });
    return;
  }

  const chains = await apiRequest('/bridge/chains');
  if (chains.error) {
    results.push({
      service: 'Bridge',
      endpoint: 'GET /bridge/chains',
      status: 'fail',
      message: chains.error,
      duration: chains.duration,
    });
  } else {
    results.push({
      service: 'Bridge',
      endpoint: 'GET /bridge/chains',
      status: 'pass',
      message: `Found ${chains.data?.length || 0} chains`,
      duration: chains.duration,
    });
  }
}

// Test Sniper Bot
async function testSniperBot() {
  console.log('\nðŸŽ¯ Testing Sniper Bot...');

  if (!accessToken) {
    results.push({
      service: 'Sniper Bot',
      endpoint: 'GET /sniper/config',
      status: 'skip',
      message: 'Authentication required',
    });
    return;
  }

  const config = await apiRequest('/sniper/config');
  if (config.error && config.status !== 404) {
    results.push({
      service: 'Sniper Bot',
      endpoint: 'GET /sniper/config',
      status: 'fail',
      message: config.error,
      duration: config.duration,
    });
  } else {
    results.push({
      service: 'Sniper Bot',
      endpoint: 'GET /sniper/config',
      status: 'pass',
      message: 'Config endpoint accessible',
      duration: config.duration,
    });
  }
}

// Test Scarlett AI
async function testScarlettAI() {
  console.log('\nðŸ¤– Testing Scarlett AI...');

  if (!accessToken) {
    results.push({
      service: 'Scarlett AI',
      endpoint: 'POST /ai/chat',
      status: 'skip',
      message: 'Authentication required',
    });
    return;
  }

  const chat = await apiRequest('/ai/chat', {
    method: 'POST',
    body: {
      message: 'Hello, what is DeFi?',
    },
  });

  if (chat.error) {
    results.push({
      service: 'Scarlett AI',
      endpoint: 'POST /ai/chat',
      status: 'fail',
      message: chat.error,
      duration: chat.duration,
    });
  } else {
    results.push({
      service: 'Scarlett AI',
      endpoint: 'POST /ai/chat',
      status: 'pass',
      message: 'Chat response received',
      duration: chat.duration,
    });
  }

  // Test health check
  const health = await apiRequest('/ai/health');
  results.push({
    service: 'Scarlett AI',
    endpoint: 'GET /ai/health',
    status: health.data?.healthy ? 'pass' : 'fail',
    message: health.data?.healthy ? 'Service healthy' : 'Service unavailable',
    duration: health.duration,
  });
}

// Main test runner
async function runAllTests() {
  console.log('ðŸš€ Starting Comprehensive Backend Services Test\n');
  console.log('='.repeat(60));

  await testAuth();
  await testMEVProtection();
  await testHoneypotDetection();
  await testBridgeService();
  await testSniperBot();
  await testScarlettAI();

  // Print summary
  console.log('\n' + '='.repeat(60));
  console.log('\nðŸ“Š TEST SUMMARY\n');

  const passed = results.filter(r => r.status === 'pass').length;
  const failed = results.filter(r => r.status === 'fail').length;
  const skipped = results.filter(r => r.status === 'skip').length;

  console.log(`âœ… Passed: ${passed}`);
  console.log(`âŒ Failed: ${failed}`);
  console.log(`â­ï¸  Skipped: ${skipped}`);
  console.log(`ðŸ“ˆ Total: ${results.length}\n`);

  // Detailed results
  console.log('ðŸ“‹ DETAILED RESULTS:\n');
  results.forEach(result => {
    const icon = result.status === 'pass' ? 'âœ…' : result.status === 'fail' ? 'âŒ' : 'â­ï¸';
    const duration = result.duration ? ` (${result.duration}ms)` : '';
    console.log(`${icon} ${result.service} - ${result.endpoint}`);
    console.log(`   ${result.message}${duration}\n`);
  });

  // Save to file
  const report = {
    timestamp: new Date().toISOString(),
    summary: {
      passed,
      failed,
      skipped,
      total: results.length,
    },
    results,
  };

  fs.writeFileSync(
    path.join(__dirname, '../TEST_REPORT.json'),
    JSON.stringify(report, null, 2)
  );

  console.log('ðŸ“„ Full report saved to: TEST_REPORT.json\n');

  // Exit with error code if any tests failed
  process.exit(failed > 0 ? 1 : 0);
}

// Run tests
runAllTests().catch(console.error);

