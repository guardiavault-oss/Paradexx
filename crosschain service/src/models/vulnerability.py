"""Vulnerability-related data models."""

from datetime import datetime
from enum import Enum
from typing import Any

from pydantic import BaseModel, Field


class SeverityLevel(str, Enum):
    """Vulnerability severity levels."""

    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class VulnerabilityType(str, Enum):
    """Types of vulnerabilities."""

    REENTRANCY = "reentrancy"
    ACCESS_CONTROL = "access_control"
    INTEGER_OVERFLOW = "integer_overflow"
    UNCHECKED_CALL = "unchecked_call"
    FRONT_RUNNING = "front_running"
    DENIAL_OF_SERVICE = "denial_of_service"
    TIMESTAMP_DEPENDENCE = "timestamp_dependence"
    RANDOMNESS = "randomness"
    GAS_LIMIT = "gas_limit"
    BRIDGE_SPECIFIC = "bridge_specific"
    CROSS_CHAIN = "cross_chain"
    GOVERNANCE = "governance"
    ECONOMIC = "economic"
    OPERATIONAL = "operational"


class Vulnerability(BaseModel):
    """Vulnerability model."""

    id: str = Field(..., description="Unique vulnerability ID")
    type: VulnerabilityType = Field(..., description="Vulnerability type")
    severity: SeverityLevel = Field(..., description="Severity level")
    title: str = Field(..., description="Vulnerability title")
    description: str = Field(..., description="Detailed description")

    # Affected contracts
    affected_contracts: list[str] = Field(..., description="List of affected contract addresses")
    affected_networks: list[str] = Field(..., description="List of affected networks")

    # Technical details
    cwe_id: str | None = Field(None, description="CWE (Common Weakness Enumeration) ID")
    cvss_score: float | None = Field(None, ge=0, le=10, description="CVSS score")
    exploitability: str | None = Field(None, description="Exploitability assessment")
    impact: str | None = Field(None, description="Impact assessment")

    # Code references
    file_path: str | None = Field(None, description="File path where vulnerability exists")
    line_number: int | None = Field(None, description="Line number of vulnerable code")
    function_name: str | None = Field(None, description="Function name containing vulnerability")

    # Detection and remediation
    detection_method: str = Field(..., description="Method used to detect vulnerability")
    remediation: str = Field(..., description="Recommended remediation")
    references: list[str] = Field(default_factory=list, description="Reference links")

    # Metadata
    discovered_at: datetime = Field(default_factory=datetime.utcnow)
    last_updated: datetime = Field(default_factory=datetime.utcnow)
    is_fixed: bool = Field(default=False, description="Whether vulnerability is fixed")
    fixed_at: datetime | None = Field(None, description="When vulnerability was fixed")

    # Cross-chain specific
    cross_chain_impact: str | None = Field(None, description="Cross-chain impact assessment")
    bridge_affected: bool | None = Field(None, description="Whether bridge is affected")
    propagation_risk: str | None = Field(None, description="Risk of propagation to other chains")


class VulnerabilityReport(BaseModel):
    """Comprehensive vulnerability report."""

    report_id: str = Field(..., description="Unique report ID")
    scan_timestamp: datetime = Field(default_factory=datetime.utcnow)
    scan_type: str = Field(..., description="Type of scan performed")

    # Scan targets
    target_contracts: list[str] = Field(..., description="Scanned contract addresses")
    target_networks: list[str] = Field(..., description="Scanned networks")

    # Summary statistics
    total_vulnerabilities: int = Field(..., description="Total number of vulnerabilities found")
    critical_count: int = Field(..., description="Number of critical vulnerabilities")
    high_count: int = Field(..., description="Number of high severity vulnerabilities")
    medium_count: int = Field(..., description="Number of medium severity vulnerabilities")
    low_count: int = Field(..., description="Number of low severity vulnerabilities")
    info_count: int = Field(..., description="Number of informational findings")

    # Overall assessment
    overall_risk_score: float = Field(..., ge=0, le=10, description="Overall risk score")
    risk_level: str = Field(..., description="Overall risk level")
    security_recommendation: str = Field(..., description="Overall security recommendation")

    # Detailed findings
    vulnerabilities: list[Vulnerability] = Field(..., description="List of found vulnerabilities")

    # Cross-chain specific analysis
    cross_chain_risks: list[dict[str, Any]] = Field(
        default_factory=list, description="Cross-chain specific risks"
    )
    shared_vulnerabilities: list[dict[str, Any]] = Field(
        default_factory=list, description="Vulnerabilities shared across chains"
    )
    bridge_vulnerabilities: list[dict[str, Any]] = Field(
        default_factory=list, description="Bridge-specific vulnerabilities"
    )

    # Recommendations
    immediate_actions: list[str] = Field(
        default_factory=list, description="Immediate actions required"
    )
    short_term_recommendations: list[str] = Field(
        default_factory=list, description="Short-term recommendations"
    )
    long_term_recommendations: list[str] = Field(
        default_factory=list, description="Long-term recommendations"
    )

    # Metadata
    scanner_version: str = Field(..., description="Scanner version used")
    scan_duration: float | None = Field(None, description="Scan duration in seconds")
    scan_metadata: dict[str, Any] = Field(
        default_factory=dict, description="Additional scan metadata"
    )
